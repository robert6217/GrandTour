import{initializeApp as G}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";import{getAuth as z,onAuthStateChanged as P,signInAnonymously as V}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";import{getFirestore as K,deleteDoc as Y,doc as Z,addDoc as Q,collection as q,serverTimestamp as X,onSnapshot as ee}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))a(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const s of r.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&a(s)}).observe(document,{childList:!0,subtree:!0});function n(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function a(o){if(o.ep)return;o.ep=!0;const r=n(o);fetch(o.href,r)}})();let U={apiKey:"",authDomain:"",projectId:"",storageBucket:"",messagingSenderId:"",appId:""};const N=localStorage.getItem("custom_firebase_config");if(N)try{U=JSON.parse(N),console.log("å·²è¼‰å…¥è‡ªè¨‚ Firebase è¨­å®š")}catch(t){console.error("è¨­å®šæª”è§£æå¤±æ•—",t)}const k="grand-tour-1c4f8";let L,w,y,O=null,$=!1;try{L=G(U),w=K(L),y=z(L),$=!0,console.log("Firebase åˆå§‹åŒ–æˆåŠŸ")}catch(t){console.error("Firebase åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ config è¨­å®š",t)}let b={name:"home",data:null};const x=[];let B={},D=!1,v={TWD:1,USD:30,MYR:7.3,THB:.95,NPR:.24,INR:.39,AED:8.85,KES:.25,EGP:.67,AMD:.08,EUR:34.5};async function te(){try{const t=await fetch("https://api.exchangerate-api.com/v4/latest/TWD");if(!t.ok)throw new Error("Network response was not ok");const n=(await t.json()).rates;for(const[a,o]of Object.entries(n))o!==0&&(v[a]=1/o);v.TWD=1,D=!0,b.name==="tools"&&H()}catch(t){console.warn("ç„¡æ³•å–å¾—å³æ™‚åŒ¯ç‡ï¼Œå°‡ä½¿ç”¨é è¨­å€¼:",t),D=!1}}const oe={é¦¬ä¾†è¥¿äº:{lat:3.139,lon:101.6869},æ³°åœ‹:{lat:13.7563,lon:100.5018},å°¼æ³Šçˆ¾:{lat:27.7172,lon:85.324},å°åº¦:{lat:28.6139,lon:77.209},æœæ‹œ:{lat:25.2048,lon:55.2708},è‚¯äº:{lat:-1.2921,lon:36.8219},åŸƒåŠ:{lat:30.0444,lon:31.2357},äºç¾å°¼äº:{lat:40.1872,lon:44.5152},å¸Œè‡˜:{lat:37.9838,lon:23.7275},ç¾©å¤§åˆ©:{lat:41.9028,lon:12.4964},å·´é»:{lat:48.8566,lon:2.3522},æœè–ä¹‹è·¯:{lat:42.8782,lon:-8.5448}};function re(t){return t===0?{icon:"â˜€ï¸",text:"æ™´æœ—"}:t>=1&&t<=3?{icon:"â›…",text:"å¤šé›²"}:t>=45&&t<=48?{icon:"ğŸŒ«ï¸",text:"æœ‰éœ§"}:t>=51&&t<=55?{icon:"ğŸŒ§ï¸",text:"æ¯›æ¯›é›¨"}:t>=56&&t<=57?{icon:"ğŸŒ§ï¸",text:"å‡é›¨"}:t>=61&&t<=65?{icon:"ğŸŒ§ï¸",text:"ä¸‹é›¨"}:t>=66&&t<=67?{icon:"ğŸŒ§ï¸",text:"å‡é›¨"}:t>=71&&t<=77?{icon:"â„ï¸",text:"é™é›ª"}:t>=80&&t<=82?{icon:"ğŸŒ¦ï¸",text:"é™£é›¨"}:t>=85&&t<=86?{icon:"â„ï¸",text:"é›ªé™£é›¨"}:t>=95&&t<=99?{icon:"â›ˆï¸",text:"é›·é›¨"}:{icon:"ğŸŒ¡ï¸",text:"æœªçŸ¥"}}async function ne(t){if(B[t])return B[t];const e=oe[t];if(!e)return"ç„¡ä½ç½®è³‡è¨Š";try{const n=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${e.lat}&longitude=${e.lon}&current_weather=true&timezone=auto`);if(!n.ok)throw new Error("Weather API error");const o=(await n.json()).current_weather;if(o){const r=re(o.weathercode),s=`${r.icon} ${r.text} ${o.temperature}Â°C`;return B[t]=s,s}}catch(n){console.warn("å¤©æ°£ç²å–å¤±æ•—:",n)}return"æš«ç„¡æ³•å–å¾—"}const h={é¦¬ä¾†è¥¿äº:{month:3,day:15},æ³°åœ‹:{month:3,day:20},å°¼æ³Šçˆ¾:{month:3,day:28},å°åº¦:{month:4,day:5},æœæ‹œ:{month:4,day:20},è‚¯äº:{month:4,day:25},åŸƒåŠ:{month:5,day:5},äºç¾å°¼äº:{month:5,day:15},å¸Œè‡˜:{month:5,day:25},ç¾©å¤§åˆ©:{month:6,day:5},å·´é»:{month:6,day:15},æœè–ä¹‹è·¯:{month:6,day:20}};let d={},u=[];async function ae(){const t=localStorage.getItem("customItineraryData");if(t)try{d=JSON.parse(t),u=Object.keys(d),console.log("å·²å¾ LocalStorage è¼‰å…¥è‡ªè¨‚è¡Œç¨‹");return}catch(e){console.error("LocalStorage è³‡æ–™ææ¯€ï¼Œå˜—è©¦è¼‰å…¥é è¨­ JSON",e)}try{const e=await fetch("/public/plan.json");if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);d=await e.json(),u=Object.keys(d),console.log("å·²è¼‰å…¥å¤–éƒ¨è¡Œç¨‹æª”æ¡ˆ itinerary_data.json")}catch(e){console.error("ç„¡æ³•è¼‰å…¥è¡Œç¨‹æª”æ¡ˆ:",e),d={è¼‰å…¥å¤±æ•—:{flag:"âš ï¸",tools:{},"Day 1":[{type:"Info",name:"è«‹æª¢æŸ¥ plan.json æ˜¯å¦å­˜åœ¨",time:"å…¨å¤©"}]}},u=["è¼‰å…¥å¤±æ•—"]}}const A=document.getElementById("content-area"),j=document.getElementById("header-title"),se=document.getElementById("back-button"),F=document.querySelectorAll(".nav-button"),S=document.getElementById("guide-backdrop"),W=document.getElementById("guide-sheet"),le=document.getElementById("sheet-title"),ie=document.getElementById("sheet-body");let c=null;function C(t,e=null){let n=3,a=15;e&&h[e]?(n=h[e].month,a=h[e].day):c&&h[c]&&(n=h[c].month,a=h[c].day);const o=parseInt(t.replace("Day ",""));if(isNaN(o))return t;let r=n,s=a+(o-1);for(;;){const i=[0,31,28,31,30,31,30,31,31,30,31,30,31];if(s<=i[r])break;s-=i[r],r++}return`${r}æœˆ${s}æ—¥`}window.openGuideModal=function(t,e,n){le.textContent=t;let a=e.replace(/\n/g,"<br>");[{keyword:"å¿…åƒç¾é£Ÿ",color:"bg-yellow-200 text-yellow-900"},{keyword:"å¿…é»èœå–®",color:"bg-red-200 text-red-900"},{keyword:"å¿…è²·ä¼´æ‰‹ç¦®",color:"bg-pink-200 text-pink-900"},{keyword:"é‡è¦é ç´„ä»£è™Ÿ",color:"bg-indigo-200 text-indigo-900"},{keyword:"æ”»ç•¥",color:"bg-green-200 text-green-900"},{keyword:"æé†’",color:"bg-orange-200 text-orange-900"},{keyword:"å°æ’‡æ­¥",color:"bg-blue-200 text-blue-900"}].forEach(r=>{const s=new RegExp(`(${r.keyword})`,"g");a=a.replace(s,`<span class="tag-style ${r.color} mr-1">${r.keyword}</span>`)}),a=a.replace(/([A-Z0-9]{5,}|[0-9]{5,})/g,'<strong class="text-lg text-red-600 bg-red-50 px-1 rounded">$1</strong>'),ie.innerHTML=`
		<div class="mb-6"><p class="text-gray-700 leading-relaxed text-base">${a}</p></div>
		<div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm">
			<h4 class="text-sm font-bold text-gray-800 mb-2">å¯ä»¥æ–°å¢ç­†è¨˜:</h4>
			<textarea class="w-full p-2 bg-gray-50 rounded border border-gray-200 text-sm focus:outline-none focus:border-red-300" rows="3" placeholder="åœ¨é€™è£¡å¯«ä¸‹æ‚¨çš„å€‹äººç­†è¨˜..."></textarea>
			<button class="mt-2 w-full py-2 bg-gray-800 text-white rounded-lg text-sm font-semibold hover:bg-gray-700">å„²å­˜ç­†è¨˜</button>
		</div>
		<button onclick="handleNavigation('${n}, ${c}')" class="mt-6 w-full py-3 bg-red-500 text-white rounded-xl shadow-lg hover:bg-red-600 transition duration-150 ease-in-out font-bold text-base flex items-center justify-center"><i class="fas fa-location-arrow mr-2"></i> ç«‹å³å°èˆª</button>
	`,S.classList.remove("hidden"),setTimeout(()=>{S.classList.add("active"),W.classList.add("active")},10)};window.closeGuideModal=function(){S.classList.remove("active"),W.classList.remove("active"),setTimeout(()=>{S.classList.add("hidden")},300)};function M(t,e,n){j.textContent=e,se.classList.toggle("hidden",!n),F.forEach(a=>{const o=a.getAttribute("data-view");t===o||t!=="tools"&&t!=="calendar"&&o==="home"?a.classList.replace("text-gray-400","text-red-500"):a.classList.replace("text-red-500","text-gray-400")})}function de(){M("calendar","æ—…ç¨‹è¡Œäº‹æ›†",!0),c=null,j.classList.remove("english-title");let t=[];u.forEach(n=>{const a=d[n];Object.keys(a).forEach(o=>{if(o.startsWith("Day")){const r=C(o,n);a[o].forEach(i=>{t.push({date:r,...i,country:n})})}})}),t.sort((n,a)=>{const o=n.date.split("æœˆ"),r=a.date.split("æœˆ"),s=parseInt(o[0]),i=parseInt(r[0]);return s!==i?s-i:parseInt(o[1])-parseInt(r[1])});const e=t.map((n,a)=>{const o="bg-white border-gray-100",r="text-red-500";let s="";return(a===0||t[a-1].date!==n.date)&&(s=`<div class="flex items-center mt-6 mb-3"><div class="w-3 h-3 rounded-full bg-red-400 mr-3 ring-4 ring-white relative z-10"></div><span class="text-sm font-bold text-gray-500">${n.date} <span class="text-xs font-normal text-gray-400 ml-1">(${n.country})</span></span></div>`),`${s}<div class="ml-4 pl-6 border-l-2 border-gray-100 relative pb-4 last:border-0 last:pb-0"><div class="minimal-shadow rounded-lg p-3 border ${o}"><div class="flex justify-between items-start"><div><h4 class="font-bold text-gray-800 text-sm flex items-center">${n.name}</h4><p class="text-xs text-gray-500 mt-1"><i class="far fa-clock mr-1"></i> ${n.time||"å…¨å¤©"}</p></div><i class="fas fa-map-marker-alt ${r} mt-1"></i></div></div></div>`}).join("");A.innerHTML=`<div class="p-2 relative"><div class="mb-4 bg-red-50 rounded-xl p-4 border border-red-100"><h3 class="font-bold text-red-800 mb-1 flex items-center"><i class="fas fa-calendar-check mr-2"></i> è¡Œç¨‹ç¸½è¦½</h3><p class="text-xs text-red-600">é€™è£¡è‡ªå‹•å½™æ•´äº†æ‚¨æ‰€æœ‰åœ‹å®¶çš„è¡Œç¨‹å®‰æ’ã€‚</p></div><div class="relative"><div class="timeline-line"></div>${e}</div><div class="text-center mt-8 pb-4"><p class="text-xs text-gray-400">--- æ—…ç¨‹å¾…çºŒ ---</p></div></div>`}function ce(t){let e,n;switch(t.type){case"Attraction":e="fas fa-camera-retro",n="bg-green-50 text-green-800";break;case"Restaurant":e="fas fa-utensils",n="bg-red-50 text-red-800";break;case"Transportation":e="fas fa-car-side",n="bg-blue-50 text-blue-800";break;default:e="fas fa-info-circle",n="bg-gray-50 text-gray-800"}const a=t.name.replace(/'/g,"\\'"),o=(t.guide||"").replace(/'/g,"\\'").replace(/\n/g,"\\n"),r=t.location.replace(/'/g,"\\'");return`<div class="minimal-shadow rounded-xl p-4 mb-4 bg-white border border-gray-100 transition duration-300 ease-in-out"><div class="flex justify-between items-start mb-3 pb-2 border-b border-gray-50"><div class="flex items-center"><div class="w-8 h-8 rounded-full ${n} flex items-center justify-center mr-3"><i class="${e} text-sm"></i></div><h3 class="text-lg font-bold text-gray-800 leading-tight">${t.name}</h3></div></div><div class="flex items-center text-sm text-gray-500 mb-4 px-1"><i class="far fa-clock mr-2"></i> ${t.time||"å…¨å¤©"}<span class="mx-2">|</span><i class="fas fa-map-marker-alt mr-2"></i> ${t.location}</div><button onclick="openGuideModal('${a}', '${o}', '${r}')" class="w-full py-2.5 bg-gray-800 text-white rounded-lg text-sm font-semibold shadow hover:bg-gray-700 transition flex items-center justify-center"><i class="fas fa-book-open mr-2"></i> æŸ¥çœ‹å°éŠæ”»ç•¥èˆ‡è©³æƒ…</button></div>`}async function I(t){const e=t||u[0];c=e,M("home","ä¸€è·¯å‘è¥¿ ç›´åˆ°ä¸–ç•Œç›¡é ­",!1),j.classList.remove("english-title");let n=document.getElementById("country-nav-scroll");const a=`<div id="country-nav-scroll" class="flex overflow-x-auto pb-2 mb-2 space-x-2 bg-white sticky top-0 z-10 pt-2 border-b border-gray-100 hide-scrollbar px-2">${u.map(l=>{let m=l.includes("(")?l.split("(")[0]:l;return`<button id="nav-btn-${l}" onclick="window.navigateTo('country', '${l}')" class="flex items-center justify-center px-4 py-2 rounded-full border text-sm font-bold transition-all duration-300 whitespace-nowrap snap-center shrink-0 nav-pill-inactive hover:bg-gray-50">${m}</button>`}).join("")}</div><div id="country-dynamic-content" class="transition-opacity duration-200"></div>`;(!n||n.querySelectorAll("button").length!==u.length)&&(A.innerHTML=a,n=document.getElementById("country-nav-scroll")),u.forEach(l=>{const m=document.getElementById(`nav-btn-${l}`);m&&(m.className=l===e?"flex items-center justify-center px-4 py-2 rounded-full border text-sm font-bold transition-all duration-300 whitespace-nowrap snap-center shrink-0 nav-pill-active shadow-md scale-105":"flex items-center justify-center px-4 py-2 rounded-full border text-sm font-bold transition-all duration-300 whitespace-nowrap snap-center shrink-0 nav-pill-inactive hover:bg-gray-50")}),requestAnimationFrame(()=>{const l=document.getElementById(`nav-btn-${e}`);l&&l.scrollIntoView({behavior:"smooth",block:"nearest",inline:"center"})});const r=`<div id="weather-section" class="mb-4 p-3 bg-blue-50 rounded-lg border border-blue-100 flex items-center justify-between"><div class="flex items-center text-blue-800"><div><p class="text-xs text-blue-500 font-bold mb-0.5">å¤©æ°£é å ±</p><p id="weather-text-inner" class="text-sm font-semibold">${await ne(e)}</p></div></div><div class="text-blue-300 text-xs">Open-Meteo</div></div>`,s=d[e]?Object.keys(d[e]).filter(l=>l.startsWith("Day")).sort():[];let i="";s.length===0?i=`<div class="text-center p-8 mt-4 bg-gray-50 rounded-xl border border-dashed border-gray-200"><span class="text-5xl text-gray-200 mb-4 block filter grayscale opacity-50">${d[e]?.flag||"ğŸ´"}</span><p class="text-base font-semibold text-gray-600">å°šæœªå®‰æ’è¡Œç¨‹</p></div>`:i=`<div class="space-y-3"><h2 class="text-lg font-bold text-gray-800 px-1 mb-2">è¡Œç¨‹ç¸½è¦½</h2>${s.map(l=>{const m=C(l,e);return`<button onclick="window.navigateTo('day', {country: '${e}', day: '${l}'})" class="minimal-shadow w-full flex items-center justify-between p-4 bg-white rounded-lg border border-gray-100 hover:bg-red-50 transition duration-150 ease-in-out group"><div class="flex items-center"><div class="w-12 h-12 rounded-xl bg-red-50 border border-red-100 flex flex-col items-center justify-center text-red-600 mr-4 group-hover:bg-red-500 group-hover:text-white transition-colors"><span class="text-xs font-bold leading-none mb-0.5">${m.split("æœˆ")[0]}æœˆ</span><span class="text-lg font-bold leading-none">${m.split("æœˆ")[1].replace("æ—¥","")}</span></div><div class="text-left"><p class="text-base font-bold text-gray-800">${l}</p><p class="text-xs text-gray-500 mt-0.5">${m}</p></div></div><i class="fas fa-chevron-right text-gray-300 group-hover:text-red-400"></i></button>`}).join("")}</div>`;const p=document.getElementById("country-dynamic-content");p&&(p.innerHTML=r+i)}function me(t){const{country:e,day:n}=t,a=C(n,e);M("day",`${e} - ${a}`,!0),c=e;const o=d[e][n]||[];A.innerHTML=`<div class="mb-4 flex items-center text-sm text-gray-500 bg-gray-50 p-3 rounded-lg border border-gray-100"><span class="mr-2 text-2xl">${d[e].flag}</span><div class="flex flex-col"><span class="font-bold text-gray-800">${e}</span><span class="text-xs">${a} è¡Œç¨‹è©³æƒ…</span></div></div>${o.map(ce).join("")}`}const E={header:()=>document.getElementById("header-title"),back:()=>document.getElementById("back-button"),content:()=>document.getElementById("content-area"),navs:()=>document.querySelectorAll(".nav-button")},ue=(t,e,n)=>{E.header().textContent=e,E.back().classList.toggle("hidden",!1),E.navs().forEach(a=>{const o=a.getAttribute("data-view"),r=t===o||t!=="tools";a.className=`nav-button flex flex-col items-center p-2 w-1/3 ${r?"text-red-500":"text-gray-400"}`})},H=()=>{ue("tools","æ—…é€”å·¥å…·ç®±");const t=`
        <div class="mb-6 bg-white rounded-xl p-4 border border-orange-200 shadow-sm mx-1">
            <h3 class="text-sm font-bold text-orange-800 mb-2 flex items-center">
                <i class="fas fa-key mr-2"></i> Firebase è¨­å®š
            </h3>
            <div class="flex justify-between items-center">
                <p class="text-xs text-gray-500">
                    ${$?'<span class="text-green-600 font-bold">â— å·²è¼‰å…¥è¨­å®š</span>':'<span class="text-red-500 font-bold">â— æœªè¨­å®š (é›¢ç·šæ¨¡å¼)</span>'}
                </p>
                <div class="flex gap-2">
                    <label class="cursor-pointer text-xs bg-orange-100 text-orange-600 px-3 py-1.5 rounded-lg hover:bg-orange-200 transition font-bold">
                        ä¸Šå‚³ Config
                        <input type="file" class="hidden" accept=".json" onchange="window.handleConfigUpload(event)">
                    </label>
                    ${$?'<button onclick="window.clearConfig()" class="text-xs bg-gray-100 text-gray-500 px-3 py-1.5 rounded-lg hover:bg-gray-200">æ¸…é™¤</button>':""}
                </div>
            </div>
        </div>
    `,e='<div class="mb-6 bg-white rounded-xl p-4 border border-gray-200 minimal-shadow mx-1"><h3 class="text-sm font-bold text-gray-700 mb-2 flex items-center"><i class="fas fa-file-import mr-2 text-blue-500"></i> è³‡æ–™ç®¡ç†</h3><button onclick="window.openEditorModal()" class="w-full mb-3 py-2.5 bg-indigo-600 text-white rounded-lg font-bold shadow-sm hover:bg-indigo-700 flex items-center justify-center"><i class="fas fa-edit mr-2"></i> é–‹å•Ÿè¡Œç¨‹ç·¨è¼¯å™¨</button><div class="flex gap-2"><label class="flex-1 cursor-pointer py-2 bg-gray-50 text-gray-600 rounded-lg text-sm font-semibold text-center hover:bg-gray-100 border border-gray-200"><i class="fas fa-upload mr-1"></i> åŒ¯å…¥ JSON<input type="file" class="hidden" accept=".json" onchange="window.handleFileUpload(event)"></label><button onclick="window.resetItinerary()" class="px-3 py-2 bg-red-50 text-red-500 rounded-lg text-sm font-semibold hover:bg-red-100 border border-red-100"><i class="fas fa-trash"></i></button></div></div>';if(c){const n=d[c].tools,a=d[c].embassy,o=d[c].flag,r=n?n.currencyCode:"",s=D?'<span class="text-xs text-green-600 bg-green-50 px-2 rounded ml-2">å³æ™‚</span>':'<span class="text-xs text-gray-500 bg-gray-100 px-2 rounded ml-2">é è¨­</span>',i=Array.isArray(d[c].accommodation)?d[c].accommodation:d[c].accommodation?[d[c].accommodation]:[],p=Array.isArray(d[c].flight)?d[c].flight:d[c].flight?[d[c].flight]:[];let l="";if(n||a){let g=a?`<div class="mt-3 pt-3 border-t border-red-100"><p class="font-bold text-sm text-red-900 mb-1">ğŸ‡¹ğŸ‡¼ å¤–é¤¨</p><p class="font-bold text-base text-gray-800">${a.name}</p><p class="text-xs text-gray-600 mt-1">${a.address}</p><button onclick="window.open('https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(a.address)}', '_blank')" class="mt-2 w-full py-1.5 bg-red-600 text-white rounded text-xs font-bold">å°èˆª</button></div>`:"";l=`<div class="minimal-shadow rounded-xl p-4 bg-red-50 border border-red-100"><h3 class="text-lg font-bold text-red-800 mb-2 flex items-center"><i class="fas fa-ambulance mr-2"></i> ç·Šæ€¥æ•‘æ´</h3><div class="space-y-1 text-sm text-gray-700"><p><strong>å ±è­¦:</strong> <span class="font-bold text-red-600 text-lg">${n?.emergency||"112"}</span></p></div>${g}</div>`}let m="";if(r&&r!=="TWD"){const g=v[r]?1/v[r]:0,_=v[r]||0;m=`<div class="minimal-shadow rounded-xl p-4 bg-white border border-gray-200"><h3 class="text-lg font-bold text-gray-800 mb-2 flex items-center"><i class="fas fa-exchange-alt mr-2 text-blue-500"></i> åŒ¯ç‡ ${s}</h3><div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg"><div class="text-center w-1/2 border-r"><p class="text-xs text-gray-500">1 TWD â‰ˆ</p><p class="text-xl font-bold text-blue-600">${_.toFixed(2)} ${r}</p></div><div class="text-center w-1/2"><p class="text-xs text-gray-500">1 ${r} â‰ˆ</p><p class="text-xl font-bold text-blue-600">${g.toFixed(2)} TWD</p></div></div></div>`}let f=i.map(g=>`<div class="minimal-shadow rounded-xl p-4 bg-green-50 border border-green-100 mb-2"><h3 class="text-lg font-bold text-green-800 mb-2 flex items-center"><i class="fas fa-bed mr-2"></i> ${g.name}</h3><p class="text-xs text-gray-700 mb-1">${g.address}</p><div class="flex gap-2 text-xs text-gray-500 mb-1"><span>In: ${g.checkIn}</span><span>Out: ${g.checkOut}</span></div><p class="text-xs text-green-700 bg-green-100 p-1 rounded">${g.note}</p><button onclick="window.open('${g.gmap}', '_blank')" class="mt-2 w-full py-1.5 bg-green-600 text-white rounded text-xs font-bold">å°èˆª</button></div>`).join(""),J=p.map(g=>`<div class="minimal-shadow rounded-xl p-4 bg-blue-50 border border-blue-100 mb-2"><h3 class="text-lg font-bold text-blue-800 mb-2 flex items-center"><i class="fas fa-plane-departure mr-2"></i> ${g.code}</h3><p class="text-xs text-gray-700 mb-1">${g.route}</p><p class="text-xs text-gray-500">${g.time}</p><p class="text-xs text-blue-600 mt-1">${g.note}</p></div>`).join("");E.content().innerHTML=`<h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2 mx-1"><i class="fas fa-tools text-red-500 mr-2"></i> ã€${o} ${c} å·¥å…·ã€‘</h2><div class="space-y-6 mx-1">${l}${m}${f}${J}<div class="minimal-shadow rounded-xl p-4 bg-yellow-50 border border-yellow-100"><h3 class="text-lg font-bold text-yellow-800 mb-2 flex items-center"><i class="fas fa-piggy-bank mr-2"></i> ${c} èŠ±è²»</h3><div id="budget-info"><p class="text-sm font-semibold text-gray-600">è¼‰å…¥ä¸­...</p></div><div id="add-expense-form" class="mt-4 p-3 bg-yellow-100 rounded-lg"><p class="font-semibold text-yellow-800 mb-2">æ–°å¢æ”¯å‡º</p><form onsubmit="window.handleExpenseSubmit(event)"><div class="flex space-x-2 mb-2"><div class="relative w-1/3"><select id="expense-currency" class="w-full p-2 border border-yellow-300 rounded text-sm bg-white"><option value="TWD">TWD</option><option value="USD">USD</option>${r&&r!=="TWD"&&r!=="USD"?`<option value="${r}">${r}</option>`:""}</select></div><input type="number" id="expense-amount" placeholder="é‡‘é¡" required step="0.01" class="w-2/3 p-2 border border-yellow-300 rounded text-sm"></div><input type="text" id="expense-description" placeholder="æè¿°" required class="w-full p-2 mb-3 border border-yellow-300 rounded text-sm"><button type="submit" class="w-full py-2 bg-yellow-600 text-white rounded shadow font-bold text-sm">å„²å­˜</button></form></div></div></div>`}else{let n="",a="";u.forEach(o=>{const r=Array.isArray(d[o].accommodation)?d[o].accommodation:d[o].accommodation?[d[o].accommodation]:[],s=Array.isArray(d[o].flight)?d[o].flight:d[o].flight?[d[o].flight]:[],i=d[o]?.flag||"";r.forEach(p=>{n+=`<div class="bg-white border-l-4 border-green-500 p-3 mb-2 rounded shadow-sm"><div class="flex justify-between items-center mb-1"><h4 class="font-bold text-sm text-gray-800"><span class="mr-2">${i}</span>${p.name}</h4><span class="text-xs text-gray-400">${o}</span></div><p class="text-xs text-gray-600 mb-1"><i class="fas fa-map-marker-alt mr-1"></i>${p.address}</p></div>`}),s.forEach(p=>{a+=`<div class="bg-white border-l-4 border-blue-500 p-3 mb-2 rounded shadow-sm"><div class="flex justify-between items-center mb-1"><h4 class="font-bold text-sm text-gray-800"><span class="mr-2">${i}</span>${p.code}</h4><span class="text-xs text-gray-400">${o}</span></div><p class="text-xs text-gray-600 mb-1"><i class="fas fa-plane mr-1"></i>${p.route}</p></div>`})}),E.content().innerHTML=`${t}${e}<h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2 mx-1"><i class="fas fa-globe-asia text-red-500 mr-2"></i> å…¨çƒé€šç”¨è³‡è¨Š</h2><div class="space-y-6 mx-1"><div class="minimal-shadow rounded-xl p-4 bg-yellow-50 border border-yellow-100"><h3 class="text-lg font-bold text-yellow-800 mb-2 flex items-center"><i class="fas fa-piggy-bank mr-2"></i> ç¸½èŠ±è²»</h3><div id="budget-info"><p class="text-sm font-semibold text-gray-600">è¼‰å…¥ä¸­...</p></div></div><div class="minimal-shadow rounded-xl p-4 bg-green-50 border border-green-100"><h3 class="text-lg font-bold text-green-800 mb-3 flex items-center"><i class="fas fa-bed mr-2"></i> ä½å®¿ç¸½è¦½</h3><div class="max-h-60 overflow-y-auto pr-1">${n||'<p class="text-xs text-gray-400">ç„¡è³‡æ–™</p>'}</div></div><div class="minimal-shadow rounded-xl p-4 bg-blue-50 border border-blue-100"><h3 class="text-lg font-bold text-blue-800 mb-3 flex items-center"><i class="fas fa-plane-departure mr-2"></i> èˆªç­ç¸½è¦½</h3><div class="max-h-60 overflow-y-auto pr-1">${a||'<p class="text-xs text-gray-400">ç„¡è³‡æ–™</p>'}</div></div></div>`}if($&&y&&y.currentUser)R();else{const n=document.getElementById("budget-info");n&&(n.innerHTML='<p class="text-sm text-gray-400">ç™»å…¥ä¸­æˆ–é›¢ç·šæ¨¡å¼ (ç„¡æ³•è®€å–é›²ç«¯è³‡æ–™)</p>')}};window.openEditorModal=()=>{const t=document.getElementById("edit-select-country");t.innerHTML='<option value="">-- æ–°å¢åœ‹å®¶ --</option>'+u.map(n=>`<option value="${n}">${d[n].flag} ${n}</option>`).join(""),window.loadCountryToEditor("");const e=document.getElementById("editor-backdrop");e.classList.remove("hidden"),e.offsetWidth,e.classList.add("active"),document.getElementById("editor-modal").classList.remove("scale-95","opacity-0"),document.getElementById("editor-modal").classList.add("scale-100","opacity-100")};window.closeEditorModal=()=>{const t=document.getElementById("editor-backdrop");t.classList.remove("active"),document.getElementById("editor-modal").classList.remove("scale-100","opacity-100"),document.getElementById("editor-modal").classList.add("scale-95","opacity-0"),setTimeout(()=>{t.classList.add("hidden")},300)};window.loadCountryToEditor=t=>{const e=(l,m)=>{const f=document.getElementById(l);f&&(f.value=m||"")},n=document.getElementById("editor-acc-container"),a=document.getElementById("editor-flight-container"),o=document.getElementById("editor-days-container");if(n.innerHTML="",a.innerHTML="",o.innerHTML="",!t){e("edit-country-name",""),e("edit-country-flag",""),e("edit-emergency",""),e("edit-timezone",""),e("edit-curr-code",""),e("edit-curr-name",""),e("edit-emb-name",""),e("edit-emb-addr",""),e("edit-emb-phone","");return}const r=d[t];if(!r)return;if(e("edit-country-name",t),e("edit-country-flag",r.flag),r.tools){e("edit-emergency",r.tools.emergency),e("edit-timezone",r.tools.timezone),e("edit-curr-code",r.tools.currencyCode);let l=r.tools.currency||"";l.includes("(")&&(l=l.split("(")[1].replace(")","")),e("edit-curr-name",l)}r.embassy&&(e("edit-emb-name",r.embassy.name),e("edit-emb-addr",r.embassy.address),e("edit-emb-phone",r.embassy.phone)),(Array.isArray(r.accommodation)?r.accommodation:r.accommodation?[r.accommodation]:[]).forEach(l=>window.addEditorAccommodation(l)),(Array.isArray(r.flight)?r.flight:r.flight?[r.flight]:[]).forEach(l=>window.addEditorFlight(l)),Object.keys(r).filter(l=>l.startsWith("Day")).sort((l,m)=>parseInt(l.replace("Day ",""))-parseInt(m.replace("Day ",""))).forEach(l=>window.addEditorDay(r[l]))};window.addEditorAccommodation=(t=null)=>{const e=document.createElement("div");e.className="bg-white border rounded p-2 text-sm relative editor-acc-row",e.innerHTML=`
        <button onclick="this.parentElement.remove()" class="absolute top-1 right-1 text-red-500 font-bold">Ã—</button>
        <input class="w-full border mb-1 p-1 rounded acc-name" placeholder="åç¨±" value="${t?.name||""}">
        <input class="w-full border mb-1 p-1 rounded acc-addr" placeholder="åœ°å€" value="${t?.address||""}">
        <div class="flex gap-1 mb-1"><input class="w-1/2 border p-1 rounded acc-in" placeholder="In" value="${t?.checkIn||""}"><input class="w-1/2 border p-1 rounded acc-out" placeholder="Out" value="${t?.checkOut||""}"></div>
        <input class="w-full border mb-1 p-1 rounded acc-note" placeholder="å‚™è¨»" value="${t?.note||""}">
        <input class="w-full border p-1 rounded acc-gmap" placeholder="Google Map é€£çµ" value="${t?.gmap||""}">
    `,document.getElementById("editor-acc-container").appendChild(e)};window.addEditorFlight=(t=null)=>{const e=document.createElement("div");e.className="bg-white border rounded p-2 text-sm relative editor-flt-row",e.innerHTML=`
        <button onclick="this.parentElement.remove()" class="absolute top-1 right-1 text-red-500 font-bold">Ã—</button>
        <div class="flex gap-1 mb-1"><input class="w-1/2 border p-1 rounded flt-code" placeholder="èˆªç­" value="${t?.code||""}"><input class="w-1/2 border p-1 rounded flt-route" placeholder="èˆªç·š" value="${t?.route||""}"></div>
        <div class="flex gap-1"><input class="w-1/2 border p-1 rounded flt-time" placeholder="æ™‚é–“" value="${t?.time||""}"><input class="w-1/2 border p-1 rounded flt-note" placeholder="å‚™è¨»" value="${t?.note||""}"></div>
    `,document.getElementById("editor-flight-container").appendChild(e)};window.addEditorDay=(t=null)=>{const e=document.getElementById("editor-days-container"),n=e.children.length+1,a=document.createElement("div");a.className="bg-white border-l-4 border-blue-500 p-3 mb-3 rounded shadow-sm editor-day-block",a.dataset.dayId=`Day ${n}`,a.innerHTML=`
        <div class="flex justify-between items-center mb-2"><h5 class="font-bold text-blue-700">Day ${n}</h5><button onclick="this.parentElement.parentElement.remove()" class="text-xs text-red-500">åˆªé™¤</button></div>
        <div class="editor-items-container space-y-2"></div>
        <button onclick="window.addEditorItem(this)" class="mt-2 text-xs text-blue-600 font-bold">+ æ™¯é»</button>
    `,e.appendChild(a);const o=a.querySelector(".editor-items-container");t&&Array.isArray(t)&&t.forEach(r=>window.createEditorItem(o,r))};window.addEditorItem=t=>{window.createEditorItem(t.previousElementSibling)};window.createEditorItem=(t,e=null)=>{const n=document.createElement("div");n.className="border p-2 rounded bg-gray-50 text-sm relative editor-item-row",n.innerHTML=`
        <button onclick="this.parentElement.remove()" class="absolute top-1 right-1 text-red-500 font-bold">Ã—</button>
        <div class="flex gap-1 mb-1">
            <select class="border p-1 rounded w-1/3 item-type"><option value="Attraction" ${e?.type==="Attraction"?"selected":""}>æ™¯é»</option><option value="Restaurant" ${e?.type==="Restaurant"?"selected":""}>é¤å»³</option><option value="Transportation" ${e?.type==="Transportation"?"selected":""}>äº¤é€š</option></select>
            <input class="border p-1 rounded w-2/3 item-name" placeholder="åç¨±" value="${e?.name||""}">
        </div>
        <div class="flex gap-1 mb-1"><input class="border p-1 rounded w-1/2 item-time" placeholder="æ™‚é–“" value="${e?.time||""}"><input class="border p-1 rounded w-1/2 item-loc" placeholder="åœ°é»" value="${e?.location||""}"></div>
        <textarea class="w-full border p-1 rounded item-guide" rows="2" placeholder="æ”»ç•¥">${e?.guide||""}</textarea>
    `,t.appendChild(n)};window.downloadEditorJSON=()=>{const t=document.getElementById("edit-country-name").value.trim();if(!t)return alert("è«‹è¼¸å…¥åœ‹å®¶åç¨±");const e=i=>document.getElementById(i)?.value||"",n=[];document.querySelectorAll(".editor-acc-row").forEach(i=>{i.querySelector(".acc-name").value&&n.push({name:i.querySelector(".acc-name").value,address:i.querySelector(".acc-addr").value,checkIn:i.querySelector(".acc-in").value,checkOut:i.querySelector(".acc-out").value,note:i.querySelector(".acc-note").value,gmap:i.querySelector(".acc-gmap").value})});const a=[];document.querySelectorAll(".editor-flt-row").forEach(i=>{i.querySelector(".flt-code").value&&a.push({code:i.querySelector(".flt-code").value,route:i.querySelector(".flt-route").value,time:i.querySelector(".flt-time").value,note:i.querySelector(".flt-note").value})});const o={flag:e("edit-country-flag"),tools:{emergency:e("edit-emergency"),currency:`${e("edit-curr-code")} (${e("edit-curr-name")})`,currencyCode:e("edit-curr-code"),timezone:e("edit-timezone")},embassy:{name:e("edit-emb-name"),address:e("edit-emb-addr"),phone:e("edit-emb-phone")},accommodation:n,flight:a};document.querySelectorAll(".editor-day-block").forEach((i,p)=>{const l=`Day ${p+1}`,m=[];i.querySelectorAll(".editor-item-row").forEach(f=>{f.querySelector(".item-name").value&&m.push({type:f.querySelector(".item-type").value,name:f.querySelector(".item-name").value,location:f.querySelector(".item-loc").value,time:f.querySelector(".item-time").value,guide:f.querySelector(".item-guide").value})}),m.length>0&&(o[l]=m)}),d[t]=o,u=Object.keys(d);const r="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(d,null,4)),s=document.createElement("a");s.setAttribute("href",r),s.setAttribute("download","itinerary_data.json"),document.body.appendChild(s),s.click(),s.remove(),localStorage.setItem("customItineraryData",JSON.stringify(d)),window.closeEditorModal(),alert("å·²ä¸‹è¼‰ JSONï¼Œä¸¦åŒæ­¥æ›´æ–°ç›®å‰é¡¯ç¤ºçš„è¡Œç¨‹ï¼"),H()};window.navigateTo=function(t,e){t==="country"&&e===c&&b.name==="country"||((b.name!==t||JSON.stringify(b.data)!==JSON.stringify(e))&&x.push(b),b={name:t,data:e},T(t,e))};window.goBack=function(){x.length>0?(b=x.pop(),T(b.name,b.data)):navigateTo("country",u[0])};function T(t,e){switch(t){case"country":I(e);break;case"day":me(e);break;case"tools":H();break;case"calendar":de();break;default:I(u[0])}}F.forEach(t=>{t.addEventListener("click",()=>{const e=t.getAttribute("data-view");e==="home"?(x.length=0,navigateTo("country",c||u[0])):navigateTo(e,null)})});window.handleNavigation=function(t){const e=`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(t)}`;window.open(e,"_blank")};window.deleteExpense=async t=>{if(confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†èŠ±è²»å—ï¼Ÿ")){if(!w||!y.currentUser||!k)return alert("ç„¡æ³•æ“ä½œ");try{await Y(Z(w,`artifacts/${k}/users/${y.currentUser.uid}/budget_entries`,t))}catch(e){console.error("åˆªé™¤å¤±æ•—",e),alert("åˆªé™¤å¤±æ•—: "+e.message)}}};window.handleConfigUpload=t=>{const e=t.target.files[0];if(!e)return;const n=new FileReader;n.onload=a=>{try{const o=JSON.parse(a.target.result);o.apiKey&&o.projectId?(localStorage.setItem("custom_firebase_config",JSON.stringify(o)),alert("è¨­å®šæª”åŒ¯å…¥æˆåŠŸï¼ç¶²é å°‡é‡æ–°æ•´ç†ä»¥å¥—ç”¨è¨­å®šã€‚"),window.location.reload()):alert("è¨­å®šæª”æ ¼å¼éŒ¯èª¤ (ç¼ºå°‘ apiKey æˆ– projectId)")}catch{alert("JSON è§£æéŒ¯èª¤")}},n.readAsText(e)};function R(){const t=y.currentUser;if(!t)return;const e=t.uid,n=q(w,`artifacts/${k}/users/${e}/budget_entries`);ee(n,a=>{const o=[];a.forEach(s=>o.push({id:s.id,...s.data()}));let r=o;c&&(r=o.filter(s=>s.country===c)),r.sort((s,i)=>(i.timestamp?.toMillis()||0)-(s.timestamp?.toMillis()||0)),pe(r)},a=>{console.error("Firestore Error:",a);const o=document.getElementById("budget-info");o&&(o.innerHTML='<p class="text-sm text-red-400">ç„¡æ³•è®€å–è³‡æ–™ (æ¬Šé™æˆ–é€£ç·šéŒ¯èª¤)</p>')})}function pe(t){const e=document.getElementById("budget-info");if(!e)return;if(t.length===0){e.innerHTML='<p class="text-sm text-gray-500">ç„¡æ”¯å‡ºè¨˜éŒ„ã€‚</p>';return}const n=t.reduce((o,r)=>o+(r.amount||0),0);let a=t.slice(0,5).map(o=>{let r=o.originalCurrency&&o.originalCurrency!=="TWD"?`<span class="text-xs text-gray-400 ml-1">(${o.originalCurrency} ${o.originalAmount})</span>`:"";return`
        <div class="flex justify-between items-center text-sm py-2 border-b border-yellow-200 group">
            <div class="flex items-center flex-grow overflow-hidden">
                 ${c?"":`<span class="mr-2 text-xs bg-gray-200 px-1 rounded">${o.country}</span>`}
                 <span class="text-gray-600 truncate mr-1">${o.description}</span>
                 ${r}
            </div>
            <div class="flex items-center flex-shrink-0">
                <span class="font-mono text-red-600 mr-3">TWD ${Math.round(o.amount)}</span>
                <button onclick="window.deleteExpense('${o.id}')" class="text-gray-400 hover:text-red-500 px-1">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>`}).join("");e.innerHTML=`<div class="mb-3 text-center p-2 bg-yellow-100 rounded-lg"><p class="text-sm font-bold text-yellow-800">ç¸½æ”¯å‡º:</p><p class="text-base font-bold text-yellow-900">TWD ${Math.round(n)}</p></div><p class="text-sm font-semibold text-gray-700 mb-1">æœ€æ–°æ”¯å‡º:</p><div class="space-y-1">${a}</div>`}window.navigateTo=(t,e)=>{x.push(b),b={name:t,data:e},T(t,e)};window.goBack=()=>{x.length?(b=x.pop(),T(b.name,b.data)):I(u[0])};window.openGuideModal=(t,e,n)=>{document.getElementById("sheet-title").textContent=t,document.getElementById("sheet-body").innerHTML=`<p class="mb-6 text-gray-700 leading-relaxed text-sm whitespace-pre-wrap">${e}</p><button onclick="window.open('https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(n)}', '_blank')" class="w-full py-3 bg-red-500 text-white rounded-xl font-bold shadow-lg">Google Maps å°èˆª</button>`,document.getElementById("guide-backdrop").classList.remove("hidden"),setTimeout(()=>{document.getElementById("guide-backdrop").classList.add("active"),document.getElementById("guide-sheet").classList.add("active")},10)};window.closeGuideModal=()=>{document.getElementById("guide-backdrop").classList.remove("active"),document.getElementById("guide-sheet").classList.remove("active"),setTimeout(()=>{document.getElementById("guide-backdrop").classList.add("hidden")},300)};window.handleExpenseSubmit=async t=>{t.preventDefault();const e=y.currentUser;if(!w||!e)return alert("è³‡æ–™åº«æœªé€£ç·šæˆ–æœªç™»å…¥");const n=document.getElementById("expense-amount"),a=document.getElementById("expense-description"),o=document.getElementById("expense-currency"),r=parseFloat(n.value),s=a.value.trim(),i=o.value;if(isNaN(r)||r<=0||s==="")return;let p=r;if(i!=="TWD"){const l=v[i]||1;p=r*l}try{await Q(q(w,`artifacts/${k}/users/${e.uid}/budget_entries`),{description:s,amount:p,originalAmount:r,originalCurrency:i,timestamp:X(),country:c||"Global"}),n.value="",a.value=""}catch(l){console.error("æ–°å¢å¤±æ•—",l),alert("æ–°å¢å¤±æ•—: "+l.message)}};window.handleFileUpload=t=>{const e=t.target.files[0];if(!e)return;const n=new FileReader;n.onload=a=>{try{const o=JSON.parse(a.target.result);typeof o=="object"&&(localStorage.setItem("customItineraryData",JSON.stringify(o)),alert("åŒ¯å…¥æˆåŠŸï¼Œè«‹é‡æ–°æ•´ç†"),location.reload())}catch{alert("JSON æ ¼å¼éŒ¯èª¤")}},n.readAsText(e)};window.resetItinerary=()=>{confirm("æ¸…é™¤è‡ªè¨‚è¡Œç¨‹?")&&(localStorage.removeItem("customItineraryData"),location.reload())};async function be(){await ae(),y&&$?P(y,t=>{O=t?t.uid:null,b.name==="tools"&&R(),O||V(y).catch(console.error),b.name==="home"&&I(u[0])}):I(u[0]),te()}document.addEventListener("DOMContentLoaded",be);
